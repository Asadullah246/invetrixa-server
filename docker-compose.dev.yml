services:
  # NestJS Application
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        NODE_VERSION: 20-alpine
    container_name: invetrixa-dev-server
    restart: unless-stopped
    env_file:
      - .env.development
    ports:
      - '${PORT:-8080}:8080'
      - '5555:5555' # Prisma Studio
    environment:
      # Override to use Docker container hostnames
      - NODE_ENV=development
      - PORT=8080
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-password}@postgres:5432/${DB_NAME:-invetrixa}?schema=public
      - REDIS_URL=redis://redis:6379
      - TZ=UTC
    volumes:
      # Selective mounts to preserve generated files from Dockerfile
      - ./src:/app/src
      - ./prisma:/app/prisma
      - ./test:/app/test
      - ./.env.development:/app/.env.development
      - ./.env.test:/app/.env.test
      - ./tsconfig.json:/app/tsconfig.json
      - ./tsconfig.build.json:/app/tsconfig.build.json
      - ./nest-cli.json:/app/nest-cli.json
      - ./prisma.config.ts:/app/prisma.config.ts
      # Preserve node_modules and generated files from image
      # - node_modules (not mounted, use from image)
      # - generated (not mounted, use from image)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app-network
    command: sh -c "pnpm exec prisma generate && pnpm exec prisma db push --accept-data-loss && pnpm run start:dev"
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:8080/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  postgres:
    image: postgres:17-alpine
    container_name: invetrixa-postgres
    restart: unless-stopped
    ports:
      - '${DB_PORT:-5432}:5432'
    environment:
      - POSTGRES_DB=${DB_NAME:-invetrixa}
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-password}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=UTC
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-invetrixa}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    command:
      - 'postgres'
      - '-c'
      - 'max_connections=200'
      - '-c'
      - 'shared_buffers=256MB'
      - '-c'
      - 'effective_cache_size=1GB'
      - '-c'
      - 'maintenance_work_mem=64MB'
      - '-c'
      - 'checkpoint_completion_target=0.9'
      - '-c'
      - 'wal_buffers=16MB'
      - '-c'
      - 'default_statistics_target=100'
      - '-c'
      - 'random_page_cost=1.1'
      - '-c'
      - 'effective_io_concurrency=200'
      - '-c'
      - 'work_mem=1310kB'
      - '-c'
      - 'min_wal_size=1GB'
      - '-c'
      - 'max_wal_size=4GB'

  redis:
    image: redis:7-alpine
    container_name: invetrixa-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - app-network
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --protected-mode no
    healthcheck:
      test: ['CMD-SHELL', 'redis-cli ping | grep PONG']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true

  # pgAdmin for database management (optional - remove in production)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: invetrixa-pgadmin
    restart: unless-stopped
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@invetrixa.com}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    ports:
      - '${PGADMIN_PORT:-5050}:80'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - tools
    logging:
      driver: 'json-file'
      options:
        max-size: '5m'
        max-file: '2'

  redis-insight:
    image: redis/redisinsight:latest
    container_name: invetrixa-redis-insight
    restart: unless-stopped
    ports:
      - '${REDIS_INSIGHT_PORT:-5540}:5540'
    volumes:
      - redis_insight_data:/data
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - tools
    logging:
      driver: 'json-file'
      options:
        max-size: '5m'
        max-file: '2'
    security_opt:
      - no-new-privileges:true

  # Portainer for Docker management UI
  portainer:
    image: portainer/portainer-ce:latest
    container_name: invetrixa-portainer
    restart: unless-stopped
    ports:
      - '${PORTAINER_PORT:-9443}:9443'
      - '${PORTAINER_HTTP_PORT:-9000}:9000'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - portainer_data:/data
    networks:
      - app-network
    # profiles:
    #   - tools
    security_opt:
      - no-new-privileges:true

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  pgadmin_data:
    driver: local
  redis_insight_data:
    driver: local
  portainer_data:
    driver: local
