# =================================================================
# Staging Docker Compose Configuration
# Multi-instance with Nginx load balancer
# =================================================================

services:
  # ─────────────────────────────────────────────────────────────────
  # Nginx Reverse Proxy - Load balances across app replicas
  # ─────────────────────────────────────────────────────────────────
  # nginx:
  #   image: nginx:alpine
  #   restart: unless-stopped
  #   ports:
  #     - '${PORT:-8080}:80'
  #   volumes:
  #     - ./nginx/staging.conf:/etc/nginx/nginx.conf:ro
  #   depends_on:
  #     - app
  #   healthcheck:
  #     test: ['CMD', 'nginx', '-t']
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - staging-network

  # ─────────────────────────────────────────────────────────────────
  # Application - Multiple replicas for high availability
  # ─────────────────────────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    # No container_name - allows multiple replicas
    restart: unless-stopped
    # ports:
    #   - '8080:8080'
    expose:
      - '8080' # Internal only, Nginx handles external traffic
    environment:
      - NODE_ENV=staging
      - PORT=8080
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SESSION_SECRET=${SESSION_SECRET}
      - CSRF_SECRET=${CSRF_SECRET}
      - FRONTEND_URL=${FRONTEND_URL}
      - LOG_LEVEL=debug
      - TZ=UTC
    env_file:
      - .env.staging
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:8080/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      replicas: 2 # Run 2 instances for high availability
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.25'
          memory: 192M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    networks:
      - staging-network

networks:
  staging-network:
    driver: bridge
